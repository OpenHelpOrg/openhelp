<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="mapbox" th:content="${mapbox}">
    <th:block th:insert="partials/head :: head"></th:block>
    <!-- Mapbox CSS -->
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet'/>
    <!-- Custom CSS -->

    <link rel="stylesheet" href="/css/home.css">
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/openhelp.css">

    <!--    <link href='../core/main.css' rel='stylesheet' />-->
    <!--    <link href='../daygrid/main.css' rel='stylesheet' />-->
    <!--    <link href="../bootstrap/main.css" rel="stylesheet" />-->
    <!--    <link href='../timegrid/main.css' rel='stylesheet' />-->
    <!--    <link href='../list/main.css' rel='stylesheet' />-->
    <!--    <script src='../core/main.js'></script>-->
    <!--    <script src='../daygrid/main.js'></script>-->
    <!--    <script src='../bootstrap/main.js'></script>-->
    <!--    <script src='../timegrid/main.js'></script>-->
    <!--    <script src='../list/main.js'></script>-->
    <!--    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" type="text/javascript"></script>-->
    <!--    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js" type="text/javascript"></script>-->
    <title>Single Event</title>
    <style>
        #map {
            /*not working*/
            height: auto;
            max-width: 100%;

        }
    </style>
</head>
<body>
<nav th:insert="partials/navbar :: navbar"></nav>
<h1 class="text-center"> Showing Single Event</h1>


<button type="button" class="btn btn-doEdit d-inline mr-0" data-toggle="modal"
        data-target="#editInfoModal"
        id="modalButton">
    Edit Profile
</button>


<div class="row p-5 justify-content-center">
    <div class="col-sm-12 col-md-8">
        <div class="card mb-3 p-2 border-dark" style="width: 100%;">
            <div class="row no-gutters">
                <div class="col-md-4">
                    <img th:src="${event.getImages()}" alt="img" class="card-img">
                    <!--    !!!!!!!!!!!!!!!!! Crashing if viewing event not created !!!!!!!!!!!!!!!!!!!!!!!!-->
                    <div class="row">
                        <ul th:if="${creator.getId() == userId}">
                            <li>
                                <!--edit post-->
                                <div class="d-flex">
                                    <a th:href="@{'/events/edit/'+${event.id}}" class="btn">
                                        <button>Edit Event</button>
                                    </a>
                                    <!--delete post-->
                                    <a th:href="@{'/events/delete/'+ ${event.id}}" class="btn">
                                        <button>Delete Event</button>
                                    </a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-body">
                        <h1 class="card-title" th:text="${event.getTitle()}"></h1>
                        <hr>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <h3>Event Location</h3>
                                <span th:text="${event.getLocation()}"></span>
                            </li>

                            <li class="list-group-item">
                                <h3>Event Date</h3>
                                <span th:text="${event.getLocation()}"></span>
                            </li>

                            <li class="list-group-item">
                                <h3>Event Summary</h3>
                                <span th:text="${event.getSummary()}"></span>
                            </li>
                            <li class="list-group-item">
                                <h3>Notes</h3>
                                <span th:text="${event.getNotes()}"></span>
                            </li>
                            <li class="list-group-item">
                                <h3>Volunteer Limit</h3>
                                <span th:text="${event.getVol_limit()}"></span>
                            </li>
                            <li class="list-group-item">
                                <div th:each="ev : ${event.getUserEvents()}">
                                    <div th:if="${ev.isIs_creator()}">
                                        <p>Created by: </p>
                                        <p>
                                            <a th:href="@{'mailto:' + ${ev.getUser().getEmail()}}"
                                               th:text="${ev.getUser().getEmail()}"></a>
                                            <a th:href="@{'/user/' + ${ev.getUser().getId()}}"
                                               th:text="${ev.getUser().getName()}"></a>
                                        </p>

                                    </div>
                                </div>
                            </li>
                            <li class="list-group-itme">
                                <div th:if="${event.getUserEvents().size() <= event.getLimit()}">
                                    <a th:href="@{'/events/singleevent/' + ${event.getId()} + '/enroll'}">Enroll</a>
                                </div>
                            </li>

                            <li class="card-footer">
                                <div th:each="category : ${event.getCategories()}">
                                    <span class="badge badge-pill badge-light" th:text="${category.getName()}"></span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="col-sm-12 col-md-4">
        <div class="card mb-3 border-dark" style="width: 100%">
            <div class="card-body">
                <h1 class="card-title"><span th:text="${event.getAddress()}"></span></h1>
                <div class="card-img-top img-fluid">
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>
</div>



<!--edit single event modal=======================-->

<div class="modal editprofilemodal" tabindex="-1" role="dialog" id="editInfoModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content editprofilemodal-content">
            <div class="modal-header editprofilemodal-header">
                <h5 class="modal-title editprofilemodal-title">Edit event information...</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!--modal pops up when user wants to edit?-->
                <!--"@{|/posts/${post.id}|}"-->
                <form class="forms" th:action="@{/events/edit}" method="post" th:object="${event}">
<!--                    <input type="hidden" th:field="*{username}">-->
                    <div class="form-group">
                        <label for="edit-title">Title</label>
                        <input type="text" class="form-control" id="edit-title" th:value="${event.title}"
                               th:field="*{event.title}" required>
                        <!--        <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>-->
                    </div>
                    <div class="form-group">
                        <label for="edit-address">Address</label>
                        <input type="text" class="form-control" id="edit-name" th:value="${user.name}"
                               th:field="*{name}" required>
                    </div>
                    <div class="form-group">
                        <!--        <label for="edit-password">Password</label>-->
                        <input type="hidden" class="form-control" id="edit-password" th:value="${user.password}"
                               th:field="*{password}">
                    </div>
                    <div class="form-group">
                        <label for="edit-phone">Telephone</label>
                        <input type="tel" class="form-control" id="edit-phone" th:value="${user.phone}"
                               th:field="*{phone}">
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="edit-isOrg" th:field="*{is_org}">
                        <label class="form-check-label ml-5" for="edit-isOrg">Are you representing an
                            Organization?</label>
                    </div>
                    <div class="form-group">
                        <label for="edit-address">Address</label>
                        <input type="text" class="form-control" id="edit-address" th:value="${user.address}"
                               th:field="*{address}">
                    </div>
                    <div class="form-group">
                        <label for="edit-website">Website</label>
                        <input type="url" class="form-control" id="edit-website" th:value="${user.website}"
                               th:field="*{website}">
                    </div>
                    <div class="form-group">
                        <label for="edit-about">Tell us about you!</label>
                        <textarea class="form-control" id="edit-about" th:text="${user.about}"
                                  th:field="*{about}"></textarea>
                    </div>
                    <!--                    <button type="submit" class="btn btn-primary">Submit</button>-->
                    <button type="submit" class="btn btn-doEdit">Save changes</button>
                    <button type="button" class="btn btn-close" data-dismiss="modal">Close</button>
                </form>
            </div>
            <div class="modal-footer">

            </div>
        </div>
    </div>
</div>


<nav th:insert="partials/navbar :: footer"></nav>
<!--<script src="https://code.jquery.com/jquery-2.2.4.js" integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI=" crossorigin="anonymous"></script>-->
<!-- Mapbox JS -->
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
<script src="/js/mapbox-geocoder-utils.js"></script>
<!-- Custom JS -->
<script>
    var token = document.querySelector('meta').content;
    mapboxgl.accessToken = token;
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v9',
        zoom: 15
    });

    var url = window.location.href;
    var id = url.substring(url.lastIndexOf('/') + 1, url.length);
    var urlJson = '/event/' + id + '/event.json';

    var request = $.ajax({'url': urlJson});
    request.done(function (event) {
        console.log(event);
        geocode(event.address, token).then(function (result) {
            map.setCenter(result);
            var marker = new mapboxgl.Marker()
                .setLngLat(result)
                .addTo(map);
        });
    });


    $('#editInfoModal').on('shown.bs.modal', function () {
        $('#modalButton').trigger('focus')
    });

    document.getElementById('picker').addEventListener('click', function (e) {
        e.preventDefault();
        picker.open();
    });

    // Set up the picker
    const client = filestack.init("AChLkyrSmK6VdYPhk8lw9z");

    //set up picker options
    const options = {
        onUploadDone: updateForm,
        maxSize: 10 * 500 * 500,
        accept: 'image/*',
        uploadInBackground: false,
    };
    const picker = client.picker(options);

    // Get references to the DOM elements

    const form = document.getElementById('pick-form');
    const fileInput = document.getElementById('fileupload');
    // const btn = document.getElementById('picker');
    const nameBox = document.getElementById('nameBox');
    const urlBox = document.getElementById('urlBox');


    // Helper to overwrite the field input value

    function updateForm(result) {
        const fileData = result.filesUploaded[0];
        fileInput.value = fileData.url;

        // Some ugly DOM code to show some data.
        const name = document.createTextNode('Selected: ' + fileData.filename);
        const url = document.createElement('a');
        url.href = fileData.url;
        url.appendChild(document.createTextNode(fileData.url));
        nameBox.appendChild(name);
        // urlBox.appendChild(document.createTextNode('Uploaded to: '));
        // urlBox.appendChild(url);
        $('#fileupload').attr('value', url);

    }


</script>
</body>
</html>